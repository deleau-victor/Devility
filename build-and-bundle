#!/bin/bash

set -e

APP_NAME="Devility"
PKG_NAME="devility-portforwardd.pkg"
DMG_NAME="DevilityInstaller.dmg"
BUNDLE_DIR="bundle"

echo "üõ†Ô∏è Compilation de portforwardd..."
cd ./portforwardd
cargo build --release
cd ..

echo "üì¶ G√©n√©ration du .pkg..."
./pkg/build-devility-pkg

echo "üåê Build de l'application Tauri..."
pnpm tauri build

APP_PATH="src-tauri/target/release/bundle/macos/${APP_NAME}.app"
PKG_PATH="pkg/${PKG_NAME}"

if [ ! -d "$APP_PATH" ]; then
  echo "‚ùå Erreur : ${APP_NAME}.app introuvable √† $APP_PATH"
  exit 1
fi

if [ ! -f "$PKG_PATH" ]; then
  echo "‚ùå Erreur : ${PKG_NAME} introuvable √† $PKG_PATH"
  exit 1
fi

echo "üìÅ Pr√©paration du dossier ${BUNDLE_DIR}/..."
rm -rf "$BUNDLE_DIR"
mkdir -p "$BUNDLE_DIR"
cp -R "$APP_PATH" "$BUNDLE_DIR/"
cp "$PKG_PATH" "$BUNDLE_DIR/DevilityHelper.pkg"

echo "üíø Cr√©ation du fichier DMG..."
create-dmg \
  --volname "$APP_NAME Installer" \
  --window-size 600 400 \
  --app-drop-link 400 200 \
  --icon "${APP_NAME}.app" 100 200 \
  --icon "DevilityHelper.pkg" 250 200 \
  "./$DMG_NAME" \
  "$BUNDLE_DIR"


echo "‚úÖ Fichier DMG cr√©√© : ./${DMG_NAME}"
